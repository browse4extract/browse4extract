name: Release Browse4Extract

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false  # Continue all builds even if one fails
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        node-version: [18.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

    - name: Build application
      run: npm run build

    - name: Package application (Windows)
      if: matrix.os == 'windows-latest'
      run: npm run package -- --win nsis zip
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Package application (macOS)
      if: matrix.os == 'macos-latest'
      run: npm run package -- --mac dmg zip
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Package application (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: npm run package -- --linux AppImage tar.gz
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts (Windows)
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: windows-artifacts
        path: |
          out/*.exe
          out/*.zip
        retention-days: 1

    - name: Upload artifacts (macOS)
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: macos-artifacts
        path: |
          out/*.dmg
          out/*.zip
        retention-days: 1

    - name: Upload artifacts (Linux)
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: linux-artifacts
        path: |
          out/*.AppImage
          out/*.tar.gz
        retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure of downloaded files
      run: ls -R artifacts/

    - name: Extract changelog for version
      id: changelog
      run: |
        VERSION="${{ github.event.inputs.version }}"

        # Extract the changelog section for this version
        # This captures everything from the version header until the next version header or end of file
        CHANGELOG=$(awk -v ver="$VERSION" '
          /^### \['"$VERSION"'\]/ { found=1; print; next }
          found && /^### \[[0-9]/ { exit }
          found && /^## [0-9]/ { exit }
          found && /^# Changelog$/ { exit }
          found { print }
        ' CHANGELOG.md)

        # If changelog is empty, provide a default message
        if [ -z "$CHANGELOG" ]; then
          CHANGELOG="See [CHANGELOG.md](https://github.com/browse4extract/browse4extract/blob/master/CHANGELOG.md) for release notes."
        fi

        # Save to output (handle multiline by using EOF delimiter)
        echo "content<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: Browse4Extract v${{ github.event.inputs.version }}
        body: |
          ${{ steps.changelog.outputs.content }}

          ---

          Changelog at https://github.com/browse4extract/browse4extract/blob/master/CHANGELOG.md
        files: |
          artifacts/windows-artifacts/*
          artifacts/macos-artifacts/*
          artifacts/linux-artifacts/*
        draft: true
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate version.json and index.html for GitHub Pages
      run: |
        VERSION="${{ github.event.inputs.version }}"
        BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        COMMIT_HASH=$(git rev-parse --short HEAD)
        REPO_URL="https://github.com/browse4extract/browse4extract"
        RELEASE_URL="$REPO_URL/releases/download/v$VERSION"

        # Create directory for GitHub Pages
        mkdir -p gh-pages-deploy

        # Generate version.json
        cat > gh-pages-deploy/version.json <<EOF
        {
          "version": "$VERSION",
          "buildDate": "$BUILD_DATE",
          "commitHash": "$COMMIT_HASH",
          "releaseUrl": "$REPO_URL/releases/tag/v$VERSION",
          "downloadLinks": {
            "windows": {
              "installer": "$RELEASE_URL/Browse4Extract.Setup.$VERSION.exe",
              "portable": "$RELEASE_URL/Browse4Extract-$VERSION-win.zip"
            },
            "macos": {
              "intel": {
                "dmg": "$RELEASE_URL/Browse4Extract-$VERSION.dmg",
                "zip": "$RELEASE_URL/Browse4Extract-$VERSION-mac.zip"
              },
              "arm64": {
                "dmg": "$RELEASE_URL/Browse4Extract-$VERSION-arm64.dmg",
                "zip": "$RELEASE_URL/Browse4Extract-$VERSION-arm64-mac.zip"
              }
            },
            "linux": {
              "appimage": "$RELEASE_URL/Browse4Extract-$VERSION.AppImage",
              "tarball": "$RELEASE_URL/browse4extract-$VERSION.tar.gz"
            }
          }
        }
        EOF

        # Generate index.html
        cat > gh-pages-deploy/index.html <<'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <meta name="robots" content="noindex, nofollow">
          <title>Browse4Extract - Version API</title>
          <style>
            :root {
              --brand-green: #6fbb69;
              --brand-green-light: #8acc85;
              --brand-green-dark: #5aa455;
              --brand-violet: #bf8fd7;
              --brand-violet-light: #d6c1e1;
              --brand-violet-dark: #a876c2;
              --bg-dark: #000000;
              --bg-dark-secondary: #0a0a0a;
              --bg-dark-tertiary: #1a1a1a;
            }

            * { margin: 0; padding: 0; box-sizing: border-box; }

            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
              background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-dark-secondary) 100%);
              color: #fff;
              min-height: 100vh;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 20px;
              -webkit-font-smoothing: antialiased;
              -moz-osx-font-smoothing: grayscale;
            }

            .container {
              background: rgba(26, 26, 26, 0.5);
              backdrop-filter: blur(10px);
              border: 1px solid rgba(255, 255, 255, 0.1);
              border-radius: 20px;
              padding: 40px;
              max-width: 900px;
              width: 100%;
              box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            }

            h1 {
              font-size: 2.5em;
              margin-bottom: 10px;
              text-align: center;
              background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-violet) 100%);
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
              background-clip: text;
            }

            .subtitle {
              text-align: center;
              color: rgba(255, 255, 255, 0.7);
              margin-bottom: 30px;
              font-size: 1.1em;
            }

            .version-info {
              background: rgba(26, 26, 26, 0.8);
              border: 1px solid rgba(255, 255, 255, 0.05);
              border-radius: 12px;
              padding: 24px;
              margin-bottom: 30px;
            }

            .info-row {
              display: flex;
              justify-content: space-between;
              padding: 12px 0;
              border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .info-row:last-child { border-bottom: none; }

            .label {
              font-weight: 600;
              color: rgba(255, 255, 255, 0.6);
            }

            .value {
              font-family: 'Courier New', monospace;
              background: rgba(0, 0, 0, 0.3);
              padding: 6px 12px;
              border-radius: 6px;
              color: var(--brand-green-light);
            }

            h2 {
              margin-bottom: 20px;
              font-size: 1.5em;
              background: linear-gradient(135deg, var(--brand-green-light) 0%, var(--brand-violet-light) 100%);
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
              background-clip: text;
            }

            .downloads {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
              gap: 20px;
              margin-top: 20px;
            }

            .download-card {
              background: rgba(26, 26, 26, 0.6);
              border: 1px solid rgba(255, 255, 255, 0.08);
              border-radius: 12px;
              padding: 20px;
              text-align: center;
              transition: all 0.3s ease;
            }

            .download-card:hover {
              transform: translateY(-4px);
              border-color: var(--brand-green);
              box-shadow: 0 0 20px rgba(111, 187, 105, 0.2);
            }

            .download-card h3 {
              margin-bottom: 15px;
              font-size: 1.3em;
              color: #fff;
            }

            .download-btn {
              display: block;
              background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-green-dark) 100%);
              color: #fff;
              text-decoration: none;
              padding: 10px 16px;
              border-radius: 8px;
              margin: 8px 0;
              transition: all 0.3s ease;
              font-size: 0.95em;
              font-weight: 500;
            }

            .download-btn:hover {
              opacity: 0.9;
              transform: translateY(-2px);
              box-shadow: 0 4px 12px rgba(111, 187, 105, 0.3);
            }

            .download-btn.secondary {
              background: linear-gradient(135deg, var(--brand-violet) 0%, var(--brand-violet-dark) 100%);
            }

            .download-btn.secondary:hover {
              box-shadow: 0 4px 12px rgba(191, 143, 215, 0.3);
            }

            .json-link {
              text-align: center;
              margin-top: 40px;
              padding-top: 30px;
              border-top: 1px solid rgba(255, 255, 255, 0.05);
            }

            .json-link p {
              color: rgba(255, 255, 255, 0.6);
              margin-bottom: 12px;
            }

            .json-link a {
              color: #fff;
              text-decoration: none;
              background: linear-gradient(135deg, var(--brand-green) 0%, var(--brand-violet) 100%);
              padding: 12px 24px;
              border-radius: 8px;
              display: inline-block;
              transition: all 0.3s ease;
              font-weight: 500;
            }

            .json-link a:hover {
              opacity: 0.9;
              transform: translateY(-2px);
              box-shadow: 0 4px 16px rgba(111, 187, 105, 0.4);
            }

            code {
              background: rgba(0, 0, 0, 0.4);
              padding: 4px 8px;
              border-radius: 4px;
              font-size: 0.9em;
              color: var(--brand-green-light);
              border: 1px solid rgba(111, 187, 105, 0.2);
            }

            .api-info {
              background: rgba(26, 26, 26, 0.6);
              border: 1px solid rgba(111, 187, 105, 0.2);
              border-radius: 8px;
              padding: 16px;
              margin-top: 16px;
              font-size: 0.9em;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>Browse4Extract</h1>
            <p class="subtitle">Version API & Downloads</p>

            <div class="version-info" id="version-info">
              <div class="info-row">
                <span class="label">Version:</span>
                <span class="value" id="version">Loading...</span>
              </div>
              <div class="info-row">
                <span class="label">Build Date:</span>
                <span class="value" id="buildDate">Loading...</span>
              </div>
              <div class="info-row">
                <span class="label">Commit Hash:</span>
                <span class="value" id="commitHash">Loading...</span>
              </div>
            </div>

            <h2>Downloads</h2>
            <div class="downloads" id="downloads">
              <div class="download-card">
                <h3>Windows</h3>
                <a href="#" class="download-btn" id="win-installer">Installer (.exe)</a>
                <a href="#" class="download-btn secondary" id="win-portable">Portable (.zip)</a>
              </div>
              <div class="download-card">
                <h3>macOS</h3>
                <a href="#" class="download-btn" id="mac-intel-dmg">DMG (Intel)</a>
                <a href="#" class="download-btn" id="mac-arm-dmg">DMG (Apple Silicon)</a>
                <a href="#" class="download-btn secondary" id="mac-intel-zip">ZIP (Intel)</a>
                <a href="#" class="download-btn secondary" id="mac-arm-zip">ZIP (Apple Silicon)</a>
              </div>
              <div class="download-card">
                <h3>Linux</h3>
                <a href="#" class="download-btn" id="linux-appimage">AppImage</a>
                <a href="#" class="download-btn secondary" id="linux-tarball">Tarball (.tar.gz)</a>
              </div>
            </div>

            <div class="json-link">
              <p>For programmatic access:</p>
              <a href="version.json" target="_blank">version.json</a>
              <div class="api-info">
                <p style="margin-bottom: 8px; color: rgba(255, 255, 255, 0.8);">API Endpoint:</p>
                <code>https://browse4extract.github.io/browse4extract/version.json</code>
              </div>
            </div>
          </div>

          <script>
            fetch('version.json')
              .then(response => response.json())
              .then(data => {
                document.getElementById('version').textContent = data.version;
                document.getElementById('buildDate').textContent = new Date(data.buildDate).toLocaleString();
                document.getElementById('commitHash').textContent = data.commitHash;

                document.getElementById('win-installer').href = data.downloadLinks.windows.installer;
                document.getElementById('win-portable').href = data.downloadLinks.windows.portable;

                document.getElementById('mac-intel-dmg').href = data.downloadLinks.macos.intel.dmg;
                document.getElementById('mac-intel-zip').href = data.downloadLinks.macos.intel.zip;
                document.getElementById('mac-arm-dmg').href = data.downloadLinks.macos.arm64.dmg;
                document.getElementById('mac-arm-zip').href = data.downloadLinks.macos.arm64.zip;

                document.getElementById('linux-appimage').href = data.downloadLinks.linux.appimage;
                document.getElementById('linux-tarball').href = data.downloadLinks.linux.tarball;
              })
              .catch(error => {
                console.error('Error loading version info:', error);
                document.getElementById('version-info').innerHTML = '<p style="text-align: center; color: #ff6b6b;">Error loading version information</p>';
              });
          </script>
        </body>
        </html>
        EOF

        echo "Generated version.json and index.html for v$VERSION"
        cat gh-pages-deploy/version.json

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./gh-pages-deploy
        publish_branch: gh-pages
        commit_message: "Update version info for v${{ github.event.inputs.version }}"
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
